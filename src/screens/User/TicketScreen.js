import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Alert,
  Dimensions,
  Image,
  Platform,
  Share,
} from 'react-native';
import { Feather } from '@expo/vector-icons';
import QRCode from 'react-native-qrcode-svg';
import { useAuth } from '../../context/AuthContext';
import { Colors, Typography, Spacing, BorderRadius, Shadows } from '../../styles/designSystem';

const { width } = Dimensions.get('window');

const TicketScreen = ({ navigation, route }) => {
  const { event, quantity = 1, purchaseId, qrCode, status, cohortName } = route.params || {};
  const { user, userProfile } = useAuth();
  const [showQR, setShowQR] = useState(true);
  const [sharing, setSharing] = useState(false);

  // Generate QR code data with ticket information
  const generateQRData = () => {
    const ticketData = {
      ticketId: qrCode || `TKT${purchaseId?.slice(-8)?.toUpperCase() || Date.now().toString().slice(-8)}`,
      eventId: event?.id || 'unknown-event',
      eventName: event?.name || 'Unknown Event',
      userId: user?.uid || 'unknown-user',
      userName: userProfile?.displayName || user?.displayName || user?.email || 'Unknown User',
      purchaseId: purchaseId || `booking-${Date.now()}`,
      quantity: quantity || 1,
      status: 'confirmed', // Always confirmed for valid tickets
      timestamp: Date.now(),
    };
    
    console.log('ðŸŽ« Generated QR Data:', ticketData); // Debug log
    const jsonString = JSON.stringify(ticketData);
    console.log('ðŸ“ QR JSON String:', jsonString);
    console.log('ðŸ” JSON String Length:', jsonString.length);
    
    // Test if the JSON can be parsed back
    try {
      const testParse = JSON.parse(jsonString);
      console.log('âœ… JSON validation successful:', testParse);
    } catch (error) {
      console.error('âŒ Generated JSON is invalid:', error);
    }
    
    return jsonString;
  };

  const shareTicket = async () => {
    try {
      setSharing(true);

      // Show options for sharing
      Alert.alert(
        'Share Ticket',
        'How would you like to share your ticket?',
        [
          {
            text: 'Share Details',
            onPress: () => shareTicketDetails()
          },
          {
            text: 'Generate PDF Link',
            onPress: () => generatePDFLink()
          },
          {
            text: 'Cancel',
            style: 'cancel'
          }
        ]
      );

    } catch (error) {
      console.error('Error sharing ticket:', error);
      Alert.alert('Share Failed', 'Unable to share ticket. Please try again.');
    } finally {
      setSharing(false);
    }
  };

  const shareTicketDetails = async () => {
    const dateDisplay = event?.endDate && event.endDate !== event.date
      ? `${event.date} to ${event.endDate}`
      : (event?.date || 'TBD');
    const cohortLine = cohortName ? `\nðŸ“‹ Session: ${cohortName}` : '';
    const ticketInfo = `ðŸŽ« ${event?.name || 'Event Ticket'}

ðŸ“… Date: ${dateDisplay}
â° Time: ${event?.time || 'TBD'}
ðŸ“ Location: ${event?.location || 'TBD'}${cohortLine}
ðŸŽŸï¸ Ticket ID: ${qrCode || `TKT${purchaseId?.slice(-8)?.toUpperCase()}`}
ðŸ‘¤ Quantity: ${quantity} ticket${quantity > 1 ? 's' : ''}

Generated by Tikiti App`;

    await Share.share({
      message: ticketInfo,
      title: `${event?.name || 'Event'} Ticket`,
    });
  };

  const generatePDFLink = async () => {
    try {
      // Generate the ticket data for QR code
      const ticketData = {
        ticketId: qrCode || `TKT${purchaseId?.slice(-8)?.toUpperCase() || Date.now().toString().slice(-8)}`,
        eventId: event?.id || 'unknown-event',
        eventName: event?.name || 'Unknown Event',
        userId: user?.uid || 'unknown-user',
        userName: userProfile?.displayName || user?.displayName || user?.email || 'Unknown User',
        purchaseId: purchaseId || `booking-${Date.now()}`,
        quantity: quantity || 1,
        status: 'confirmed',
        timestamp: Date.now(),
      };

      // Create a web URL that will generate the PDF
      const baseUrl = 'https://tikiti-app.vercel.app'; // Your web app URL
      const pdfUrl = `${baseUrl}/ticket-pdf?data=${encodeURIComponent(JSON.stringify({
        event: {
          name: event?.name,
          date: event?.date,
          time: event?.time,
          location: event?.location,
          id: event?.id
        },
        ticket: ticketData,
        user: {
          name: userProfile?.displayName || user?.displayName || user?.email,
          email: user?.email
        }
      }))}`;

      const shareMessage = `ðŸŽ« Download your ticket PDF:

${event?.name || 'Event Ticket'}
ðŸ“… ${event?.endDate && event.endDate !== event.date ? `${event.date} to ${event.endDate}` : (event?.date || 'TBD')} at ${event?.time || 'TBD'}

Click to download: ${pdfUrl}

Keep this link safe - it contains your QR code for entry!`;

      await Share.share({
        message: shareMessage,
        title: 'Ticket PDF Download',
      });

    } catch (error) {
      console.error('Error generating PDF link:', error);
      Alert.alert('Error', 'Failed to generate PDF link. Please try sharing details instead.');
    }
  };

  const QRCodeComponent = () => {
    // Generate real ticket data using actual values
    const ticketData = JSON.stringify({
      ticketId: qrCode || `TKT${purchaseId?.slice(-8)?.toUpperCase() || Date.now().toString().slice(-8)}`,
      eventId: event?.id || 'unknown-event',
      eventName: event?.name || 'Unknown Event',
      userId: user?.uid || 'unknown-user',
      userName: userProfile?.displayName || user?.displayName || user?.email || 'Unknown User',
      purchaseId: purchaseId || `booking-${Date.now()}`,
      quantity: quantity || 1,
      status: 'confirmed', // Always confirmed for valid tickets
      timestamp: Date.now(),
    });

    console.log('ðŸŽ« Generated ticket QR data:', ticketData);

    return (
    <View style={styles.qrSection}>
      <View style={styles.qrCodeWrapper}>
          <QRCode
            value={ticketData}
            size={200}
            color="black"
            backgroundColor="white"
            logoBackgroundColor="transparent"
          />
      </View>
      <View style={styles.qrLabelContainer}>
        <Feather name="camera" size={16} color={Colors.text.tertiary} style={{ marginRight: 8 }} />
        <Text style={styles.qrLabel}>Scan at venue entrance</Text>
      </View>
      {qrCode && (
        <View style={styles.qrCodeTextContainer}>
          <Feather name="hash" size={12} color={Colors.text.disabled} style={{ marginRight: 4 }} />
          <Text style={styles.qrCodeText}>{qrCode}</Text>
        </View>
      )}

    </View>
  );
  };

  const TicketCard = ({ ticketNumber = 1 }) => (
    <View style={styles.ticketCard}>
      <View style={styles.ticketHeader}>
        <View style={styles.ticketHeaderContent}>
          <View style={styles.ticketTitleContainer}>
            <Feather name="tag" size={18} color={Colors.white} style={{ marginRight: 8 }} />
            <Text style={styles.ticketTitle}>EVENT TICKET</Text>
          </View>
          <View style={styles.ticketNumberContainer}>
            <Feather name="hash" size={14} color="rgba(255, 255, 255, 0.9)" style={{ marginRight: 4 }} />
            <Text style={styles.ticketNumber}>{(purchaseId || 'TKT-12345') + `-${ticketNumber}`}</Text>
          </View>
        </View>
      </View>

      <View style={styles.ticketBody}>
        <Text style={styles.eventName}>{event?.name || 'Sample Event'}</Text>
        
        <View style={styles.ticketDetails}>
          <View style={styles.detailRow}>
            <View style={styles.detailIconContainer}>
              <Feather name="calendar" size={16} color={Colors.success[500]} />
            </View>
            <Text style={styles.detailLabel}>Date:</Text>
            <Text style={styles.detailValue}>
              {event?.endDate && event.endDate !== event.date
                ? `${event.date} to ${event.endDate}`
                : (event?.date || 'TBD')}
            </Text>
          </View>
          
          <View style={styles.detailRow}>
            <View style={styles.detailIconContainer}>
              <Feather name="clock" size={16} color={Colors.warning[500]} />
            </View>
            <Text style={styles.detailLabel}>Time:</Text>
            <Text style={styles.detailValue}>{event?.time || '6:00 PM'}</Text>
          </View>
          
          <View style={styles.detailRow}>
            <View style={styles.detailIconContainer}>
              <Feather name="map-pin" size={16} color={Colors.error[500]} />
            </View>
            <Text style={styles.detailLabel}>Venue:</Text>
            <Text style={styles.detailValue}>{event?.location || 'Sample Venue'}</Text>
          </View>

          {cohortName ? (
            <View style={styles.detailRow}>
              <View style={styles.detailIconContainer}>
                <Feather name="layers" size={16} color={Colors.primary[500] || '#6366f1'} />
              </View>
              <Text style={styles.detailLabel}>Session:</Text>
              <Text style={styles.detailValue}>{cohortName}</Text>
            </View>
          ) : null}

          <View style={styles.detailRow}>
            <View style={styles.detailIconContainer}>
              <Feather name="dollar-sign" size={16} color={Colors.success[500]} />
            </View>
            <Text style={styles.detailLabel}>Price:</Text>
            <Text style={styles.detailValue}>{event?.price || 'â‚µ80'}</Text>
          </View>
          
          {status && (
            <View style={styles.detailRow}>
              <View style={styles.detailIconContainer}>
                <Feather 
                  name={status === 'confirmed' ? 'check-circle' : status === 'used' ? 'clock' : 'x-circle'} 
                  size={16} 
                  color={status === 'confirmed' ? Colors.success[500] : status === 'used' ? Colors.text.tertiary : Colors.error[500]}
                />
              </View>
              <Text style={styles.detailLabel}>Status:</Text>
              <Text style={[styles.detailValue, styles.statusText, { 
                color: status === 'confirmed' ? Colors.success[500] : status === 'used' ? Colors.text.tertiary : Colors.error[500]
              }]}>
                {status === 'confirmed' ? 'Confirmed' : status === 'used' ? 'Used' : 'Cancelled'}
              </Text>
            </View>
          )}
        </View>

        {showQR && <QRCodeComponent />}

        <View style={styles.attendeeSection}>
          <View style={styles.attendeeHeader}>
            <Feather name="user" size={18} color={Colors.primary[500]} />
            <Text style={styles.attendeeLabel}>Attendee:</Text>
          </View>
          <View style={styles.attendeeInfo}>
            <Feather name="user-check" size={16} color={Colors.success[500]} style={{ marginRight: 8 }} />
            <Text style={styles.attendeeName}>
              {userProfile?.displayName || user?.displayName || 'Attendee'}
            </Text>
          </View>
          <View style={styles.attendeeInfo}>
            <Feather name="mail" size={16} color={Colors.text.tertiary} style={{ marginRight: 8 }} />
            <Text style={styles.attendeeEmail}>
              {user?.email || 'No email available'}
            </Text>
          </View>
        </View>
      </View>

      <View style={styles.ticketFooter}>
        <Text style={styles.footerText}>Valid for event date only</Text>
        <Text style={styles.footerText}>Powered by Tikiti</Text>
      </View>
    </View>
  );

  return (
    <View style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity
          style={styles.backButton}
          onPress={() => navigation.goBack()}
        >
          <Feather name="arrow-left" size={20} color={Colors.primary[500]} />
          <Text style={styles.backButtonText}>Back</Text>
        </TouchableOpacity>
        
        <View style={styles.headerTitleContainer}>
          <Feather name="tag" size={20} color={Colors.text.primary} style={{ marginRight: 8 }} />
          <Text style={styles.headerTitle}>My Ticket{quantity > 1 ? 's' : ''}</Text>
        </View>
        
        <TouchableOpacity 
          style={styles.shareButton}
          onPress={shareTicket}
          disabled={sharing}
        >
          <Feather 
            name={sharing ? "share" : "share-2"} 
            size={20} 
            color={sharing ? Colors.text.disabled : Colors.primary[500]}
          />
        </TouchableOpacity>
      </View>

      <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>
        <View style={styles.purchaseConfirmation}>
          <View style={styles.confirmationIconContainer}>
            <Feather name="check-circle" size={32} color={Colors.success[500]} />
          </View>
          <Text style={styles.confirmationTitle}>Purchase Confirmed!</Text>
          <View style={styles.confirmationTextContainer}>
            <Feather name="mail" size={16} color={Colors.text.tertiary} style={{ marginRight: 8 }} />
            <Text style={styles.confirmationText}>
              Your ticket{quantity > 1 ? 's have' : ' has'} been sent to your email
            </Text>
          </View>
        </View>

        {Array.from({ length: quantity }, (_, index) => (
          <TicketCard key={index} ticketNumber={index + 1} />
        ))}

        <View style={styles.actionButtons}>
          <TouchableOpacity style={styles.walletButton}>
            <Feather name="credit-card" size={18} color={Colors.white} style={{ marginRight: 8 }} />
            <Text style={styles.walletButtonText}>Add to Wallet</Text>
          </TouchableOpacity>
          
          <TouchableOpacity
            style={styles.toggleQRButton}
            onPress={() => setShowQR(!showQR)}
          >
            <Feather 
              name={showQR ? 'eye-off' : 'eye'} 
              size={18} 
              color={Colors.primary[500]}
              style={{ marginRight: 8 }}
            />
            <Text style={styles.toggleQRButtonText}>
              {showQR ? 'Hide QR' : 'Show QR'}
            </Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.background.secondary,
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingTop: 50,
    paddingBottom: 20,
    backgroundColor: Colors.background.primary,
  },
  backButton: {
    paddingVertical: 8,
    paddingHorizontal: 12,
    flexDirection: 'row',
    alignItems: 'center',
  },
  backButtonText: {
    fontSize: 16,
    color: Colors.primary[500],
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
  },
  headerTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  headerTitle: {
    fontSize: 18,
    fontFamily: Typography.fontFamily.bold,
    fontWeight: 'bold',
    color: Colors.text.primary,
  },
  shareButton: {
    paddingVertical: 8,
    paddingHorizontal: 12,
  },
  shareButtonText: {
    fontSize: 16,
    fontFamily: Typography.fontFamily.regular,
  },
  content: {
    flex: 1,
    padding: 20,
  },
  purchaseConfirmation: {
    backgroundColor: Colors.background.primary,
    borderRadius: BorderRadius['3xl'],
    padding: 24,
    alignItems: 'center',
    marginBottom: 20,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
    ...Shadows.md,
  },
  confirmationIconContainer: {
    marginBottom: 12,
  },
  confirmationTitle: {
    fontSize: 20,
    fontFamily: Typography.fontFamily.bold,
    fontWeight: 'bold',
    color: Colors.success[500],
    marginBottom: 12,
  },
  confirmationTextContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  confirmationText: {
    fontSize: 14,
    fontFamily: Typography.fontFamily.regular,
    color: Colors.text.tertiary,
    textAlign: 'center',
  },
  ticketCard: {
    backgroundColor: Colors.background.primary,
    borderRadius: BorderRadius['3xl'],
    marginBottom: 20,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
    ...Shadows.xl,
    overflow: 'hidden',
  },
  ticketHeader: {
    backgroundColor: Colors.primary[500],
    padding: 16,
  },
  ticketHeaderContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  ticketTitle: {
    color: Colors.white,
    fontSize: 16,
    fontFamily: Typography.fontFamily.bold,
    fontWeight: 'bold',
  },
  ticketNumber: {
    color: 'rgba(255, 255, 255, 0.9)',
    fontSize: 12,
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
  },
  ticketBody: {
    padding: 20,
  },
  eventName: {
    fontSize: 24,
    fontFamily: Typography.fontFamily.bold,
    fontWeight: 'bold',
    color: Colors.text.primary,
    marginBottom: 20,
    textAlign: 'center',
  },
  ticketDetails: {
    marginBottom: 24,
  },
  detailRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 8,
    borderBottomWidth: 1,
    borderBottomColor: Colors.border.light,
  },
  detailIconContainer: {
    width: 24,
    alignItems: 'center',
    marginRight: 12,
  },
  detailLabel: {
    fontSize: 14,
    color: Colors.text.tertiary,
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
    flex: 1,
    marginLeft: 8,
  },
  detailValue: {
    fontSize: 14,
    color: Colors.text.primary,
    fontFamily: Typography.fontFamily.medium,
    fontWeight: '500',
    flex: 2,
    textAlign: 'right',
  },
  statusText: {
    fontFamily: Typography.fontFamily.bold,
    fontWeight: '700',
    textTransform: 'uppercase',
    fontSize: 12,
  },
  qrSection: {
    alignItems: 'center',
    marginVertical: 24,
    backgroundColor: Colors.background.secondary,
    borderRadius: 16,
    padding: 20,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
  },
  qrCodeWrapper: {
    alignItems: 'center',
    marginBottom: 16,
  },
  qrCode: {
    width: 160,
    height: 160,
    backgroundColor: Colors.background.primary,
    borderRadius: 12,
    padding: 16,
    ...Shadows.md,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
  },
  qrPattern: {
    flex: 1,
  },
  qrRow: {
    flexDirection: 'row',
    flex: 1,
  },
  qrPixel: {
    flex: 1,
    margin: 0.5,
  },
  qrLabelContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 12,
  },
  qrLabel: {
    fontSize: 13,
    color: Colors.text.tertiary,
    fontFamily: Typography.fontFamily.medium,
    fontWeight: '500',
    textAlign: 'center',
  },
  qrCodeTextContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 8,
    backgroundColor: Colors.background.tertiary,
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 8,
  },
  qrCodeText: {
    fontSize: 11,
    color: Colors.text.tertiary,
    fontFamily: Typography.fontFamily.mono,
    fontWeight: '600',
  },
  attendeeSection: {
    backgroundColor: Colors.background.secondary,
    padding: 16,
    borderRadius: 12,
    marginBottom: 20,
    borderWidth: 1,
    borderColor: 'rgba(0,0,0,0.1)',
  },
  attendeeHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 12,
  },
  attendeeLabel: {
    fontSize: 13,
    color: Colors.primary[500],
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
    textTransform: 'uppercase',
    marginLeft: 8,
  },
  attendeeInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
  },
  attendeeName: {
    fontSize: 16,
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
    color: Colors.text.primary,
  },
  attendeeEmail: {
    fontSize: 14,
    fontFamily: Typography.fontFamily.regular,
    color: Colors.text.tertiary,
  },
  ticketFooter: {
    backgroundColor: Colors.background.secondary,
    padding: 12,
    flexDirection: 'row',
    justifyContent: 'space-between',
    borderTopWidth: 1,
    borderTopColor: 'rgba(0,0,0,0.1)',
  },
  footerText: {
    fontSize: 10,
    color: Colors.text.disabled,
    fontFamily: Typography.fontFamily.medium,
    fontWeight: '500',
  },
  actionButtons: {
    flexDirection: 'row',
    gap: 12,
    marginBottom: 24,
  },
  walletButton: {
    flex: 1,
    backgroundColor: Colors.primary[500],
    paddingVertical: 16,
    borderRadius: BorderRadius.md,
    alignItems: 'center',
    flexDirection: 'row',
    justifyContent: 'center',
  },
  walletButtonText: {
    color: Colors.white,
    fontSize: 14,
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
  },
  toggleQRButton: {
    flex: 1,
    backgroundColor: Colors.background.secondary,
    paddingVertical: 16,
    borderRadius: BorderRadius.md,
    alignItems: 'center',
    flexDirection: 'row',
    justifyContent: 'center',
    borderWidth: 1,
    borderColor: Colors.primary[500],
  },
  toggleQRButtonText: {
    color: Colors.primary[500],
    fontSize: 14,
    fontFamily: Typography.fontFamily.semibold,
    fontWeight: '600',
  },
  // New icon container styles
  ticketTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  ticketNumberContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
});

export default TicketScreen;